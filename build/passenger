#!/bin/bash

# "Phusion Passenger is a multi-language (Ruby, Python, Node) web & app server
#  which can integrate into Apache and Nginx. Easy to use, stable and fast."

readonly service_cfg=${0%/scripts*}/etc/service.cfg

. ${service_cfg} && . ${scripts_base}/common

readonly pkg_name=passenger

install_prereq ruby "mandatory"
install_prereq zlib "mandatory"
install_prereq openssl "mandatory"
install_prereq apr "mandatory"
install_prereq apr-util "mandatory"
install_prereq apache "mandatory"
install_prereq curl "mandatory"

${usr_prefix}/ruby/bin/gem install rake
${usr_prefix}/ruby/bin/gem install bundler
${usr_prefix}/ruby/bin/gem install passenger

# Apache module dependencies: openssl-dev, zlib-dev, apache2-dev, libcurl

export PATH=${usr_prefix}/httpd/bin/:${usr_prefix}/curl/bin:${PATH}
export C_INCLUDE_PATH=${usr_prefix}/openssl/include:${usr_prefix}/zlib/include:${usr_prefix}/httpd/include:${usr_prefix}/curl/include
# passenger installer checks pass with C_INCLUDE_PATH (C specific),
# but g++ later needs CPATH (used for all languages)
export CPATH=${usr_prefix}/openssl/include:${usr_prefix}/zlib/include:${usr_prefix}/httpd/include:${usr_prefix}/curl/include
export LIBRARY_PATH=${usr_prefix}/openssl/lib:${usr_prefix}/zlib/lib:${usr_prefix}/httpd/lib:${usr_prefix}/curl/lib
export LD_LIBRARY_PATH=${usr_prefix}/openssl/lib:${usr_prefix}/zlib/lib:${usr_prefix}/httpd/lib:${usr_prefix}/curl/lib

# -a -> unattended install
${usr_prefix}/ruby/bin/passenger-install-apache2-module -a --apr-config-path ${usr_prefix}/apr/bin/apr-1-config --apxs2-path ${usr_prefix}/httpd/bin/apxs --languages ruby,python,nodejs,meteor

# !!!! integrate passenger config into mkhttpd_conf or service.conf

cat <<EOF
   Add passenger module config to apache:
---
   # @see https://www.phusionpassenger.com/library/deploy/apache/deploy/
   LoadModule passenger_module /services/scm/usr/ruby-2.4.1/lib/ruby/gems/2.4.0/gems/passenger-5.1.8/buildout/apache2/mod_passenger.so            
   <IfModule mod_passenger.c>       
     PassengerRoot /services/scm/usr/ruby-2.4.1/lib/ruby/gems/2.4.0/gems/passenger-5.1.8                                                          
     PassengerDefaultRuby /services/scm/usr/ruby-2.4.1/bin/ruby          
   </IfModule> 
-------

EOF
