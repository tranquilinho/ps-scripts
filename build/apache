#!/bin/bash

readonly service_cfg=${0%/scripts*}/etc/service.cfg

. ${service_cfg} && . ${scripts_base}/common

readonly pkg_name=httpd
readonly pkg_version=2.4.29
# !!!! this mirror keeps only the latest stable version?
readonly url_base=http://apache.rediris.es//httpd/

log "${info} ${pkg_name} install started"

[ -z "${spack_modules}" ] && echo "Spack modules directory undefined" && exit 2

# libxml2 is required by proxy-html 
# !!!! spack
# install_prereq libxml2 "mandatory"
spack load --dependencies libxml2${libxml2_version}
# currently openssl 1.1 is not supported ("undefined reference to CRYPTO_malloc_init")
# !!!! remove 1.0 when 1.1 or newer is supported
#[ "${https_enabled}" == "1" ] && install_prereq openssl "mandatory" 1.0
spack load --dependencies openssl
install_prereq apr-util "mandatory"
spack load --dependencies pcre
# install_prereq pcre "mandatory"

readonly os_aux=$(grep "^ID=" /etc/os-release)
readonly os=${os_aux##ID=}

# !!!! debian: uuid-dev, centos uuid-devel
os_install uuid-devel

[ -n "${php_enabled}" -a ${php_enabled} -eq 1 ] && install_prereq php "mandatory"

build_preconditions

cat ${scripts_base}/build/apache-portable.layout >> config.layout

# Multiprocessing
# in unix, there are 3 modules: prefork (no threads), worker (threads available) and event (thread-safe polling available, usually the default MPM)
# You can setup MPM as modules (--enable-mpms-shared=all) or static ( --with-mpm=module)

# for ldap support in apache, apr-util must be build with ldap support too (specyfing where the ldap libs are)

# There are 2 types of CGI support:
# --enable-cgid  (default with threaded MPMs)
# --enable-cgi   (default with non-threaded MPMs)
[ "${cgi_enabled}" == "1" ] && cgi_param="--enable-cgi"
[ "${https_enabled}" == "1" ] && ssl_param="--enable-ssl"



# !!!! with-libz

# after loading module, LD_LIBRARY_PATH contains the path to its library
readonly xml2lib=$(echo $LD_LIBRARY_PATH | tr ':' '\n' | grep libxml2)
readonly xml2dir=${xml2lib%%lib}
readonly zlib=$(echo $LD_LIBRARY_PATH | tr ':' '\n' | grep zlib)
readonly zlibdir=${zlib%%lib}

./configure --prefix=${prefix} --enable-layout=Portable --datadir=${data_dir} --localstatedir=${service_root} --enable-pie -enable-authn-dbm --enable-authz-dbm --enable-ratelimit --enable-log-debug ${cgi_param} ${ssl_param} --with-apr=${usr_prefix}/apr --with-apr-util=${usr_prefix}/apr-util  --enable-proxy-html --with-libxml2=${xml2dir}/include/libxml2 --with-z=${zlibdir} | logalize $(configure_log)

standard_install
