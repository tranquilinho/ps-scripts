#!/bin/bash

readonly service_cfg=${0%/scripts*}/etc/service.cfg

. ${service_cfg} && . ${scripts_base}/common

# !!!! ensure pkg_config is reachable (installed and on $PATH)
# it is needed for zlib and openssl (at least)

readonly pkg_name=ruby
readonly pkg_version=2.4.1
readonly url_base=https://cache.ruby-lang.org/pub/ruby/2.4/

install_prereq zlib "mandatory"
install_prereq openssl "mandatory"

readonly available_ruby=$(${usr_prefix}/ruby/bin/ruby -v 2>&1 )

if [[ "${available_ruby}" == ruby* ]]; then
    log "${warning} ${available_ruby} already installed..."
    exit 0
fi


build_preconditions

export PATH=${PATH}:${usr_prefix}/pkg-config/bin

# export C_INCLUDE_PATH=.../include
# export CFLAGS=-L/.../lib

./configure --prefix=${prefix} --with-zlib-dir=${usr_prefix}/zlib

standard_install

# modules are prepared automatically by standard_install

# openssl ext needs pkg-config
#cd ext/openssl
#${prefix}/bin/ruby extconf.rb 
#make -j 2
#make install

# zlib searches for -lz only in default + --with-zlib-dir (no pkg-config)
#cd ../..
#cd ext/zlib
#${prefix}/bin/ruby extconf.rb 
#make -j 2
#make install

# test:
#${prefix}/bin/ruby -ropenssl -rzlib -rreadline -e "puts :success"
